<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<video id="camera" autoplay="true"></video>
<div id="result"></div>
<div id="progressText">Scanning in progress...</div>
<button id="scanButton">Scan</button>
<script>
    const video = document.querySelector("#camera");
    const resultDiv = document.querySelector("#result");
    const progressText = document.querySelector("#progressText"); // Add this line
    let scanCount = 51;
    let maxScanCount = 50;
    let sendData = false;
    let ids = {};

    scanButton.addEventListener("click", function() {
        scanCount = 0; // Reset scan count
        sendData = true;
        ids = {};
        progressText.textContent = "Scanning in progress..."; // Update progress text
    });

    // Get user media (camera) stream
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
            // Assign the camera stream to the video element
            video.srcObject = stream;
        })
        .catch(function(err) {
            console.error("Camera access error:", err);
        });

    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: video, // Use the video element as the target
        },
        decoder: {
            readers: ["ean_reader", "code_128_reader", "code_39_reader", "upc_reader"]
        },
    }, function(err) {
        if (err) {
            console.error("Quagga initialization failed:", err);
            return;
        }
        Quagga.start();

        // Handle the detected event
        Quagga.onDetected(function(result) {
            scanCount++;
            if (scanCount <= maxScanCount) {
                const code = result.codeResult.code;
                if (ids[code] == undefined) {
                    ids[code] = 1;
                } else {
                    ids[code]++;
                }
                console.log(code, ids[code]);
                progressText.textContent = "Scanning - " + ((100/maxScanCount) * scanCount) + "%"; // Update progress text
            }

            if (scanCount > maxScanCount && sendData == true) {
                id = Object.keys(ids).reduce((a, b) => ids[a] > ids[b] ? a : b);
                console.log("Sending data to server " + id);
                sendData = false;
                progressText.textContent = "Scan complete"; // Update progress text
            }
        });
    });

</script>
